<!DOCTYPE html>

<html class="no-js" lang="en" class="js flexbox canvas canvastext webgl no-touch geolocation postmessage no-websqldatabase indexeddb hashchange history draganddrop websockets rgba hsla multiplebgs backgroundsize borderimage borderradius boxshadow textshadow opacity cssanimations csscolumns cssgradients no-cssreflections csstransforms csstransforms3d csstransitions fontface generatedcontent video audio localstorage sessionstorage webworkers applicationcache svg inlinesvg smil svgclippaths">
<head id="ContentPlaceHolderDefault_Head1">
    <meta http-equiv="X-UA-Compatible" content="IE=9,chrome=1" />
    <meta charset=UTF-8" />
    <title>Windows Azure 培训包 - 将 PaaS 应用程序连接到 IaaS 应用程序</title>
    <link rel="Stylesheet" type="text/css" media="all" href="styles/master.css" />
</head>
<body id="top" class="page-">
    <div id="page">
        <div id="wrapper" class="landingPage getStartedPage">            
            <div class="header">								
				<img alt="Windows Azure" src="images/azure-logo.png" /> <span class="mainHomepageSubTitle">培训包 - 2013 年 4 月更新</span>								
			</div>			
			<div class="nav-menu-header">
				<nav>
					<ul>
						<li class="MenuLink-Selected">
							<a href="#">内容</a>
						</li>
												<li class="MenuLink">
							<a href="Source">设置</a>
						</li>
											</ul>
				
										
						<span id="github-btn" class="github-btn"> <a id="gh-btn" title="在 GitHub 中复制此存储库的分支" href="https://github.com/WindowsAzure-TrainingKit/HOL-ConnectingApplications" target="_blank" class="gh-btn"> <span class="gh-ico"></span> <span id="gh-text" class="gh-text">分支</span> </a> </span> <span id="github-btn" class="github-btn github-watchers"> <a id="gh-btn" title="在 GitHub 中关注此存储库" href="https://github.com/WindowsAzure-TrainingKit/HOL-ConnectingApplications" target="_blank" class="gh-btn"> <span class="gh-ico"></span> <span id="gh-text" class="gh-text">关注</span> </a> </span>
						
									
				</nav>
			</div>	        
		</span>
			<div id="content" class="textpage">
            <section id="content-container">
				<div id="content" class="textpage">
			    <a name="top"></a>
				
				

		<div class="content">
			<?xml version="1.0" encoding="iso-8859-1"?><span><p><a name="handsonlab"></a></p>

<h1 id="Connecting_a_PaaS_application_to_an_IaaS_Application">将 PaaS 应用程序连接到 IaaS 应用程序</h1>

<hr />

<p><a name="Overview"></a></p>

<h2 id="Overview">概述</h2>

<p>在此实验中，您将使用 Windows Azure 管理门户创建一个安装了 SQL Server 的虚拟机。然后您将修改一个示例 Web 应用程序并使用公用端点连接到 SQL Server。最后，您将获得两个不同的托管服务，包含相互通信的不同实例。这种通信称为<strong>简单混合模式</strong>。</p>

<p><a name="Objectives"></a></p>

<h3 id="Objectives">目标</h3>

<p>在此动手实验中，您将学习如何执行以下操作：</p>

<ul>
<li>配置 SQL Server 虚拟机</li>
<li>使用公共端点连接示例 Web 应用程序和 SQL Server</li>
<li>将示例 Web 应用程序部署到 Windows Azure 中的云应用</li>
</ul>

<p><a name="Prerequisites"></a></p>

<h3 id="Prerequisites">先决条件</h3>

<p>下面是完成此动手实验需要满足的先决条件：</p>

<ul>
<li><a href="http://www.microsoft.com/visualstudio/">Visual Studio Express 2012 for Web</a> 或更高版本</li>
<li><a href="http://www.microsoft.com/windowsazure/sdk/">Windows Azure Tools for Microsoft Visual Studio 1.8</a></li>
<li>Windows Azure 订阅 - <a href="http://aka.ms/WATK-FreeTrial">注册以免费试用</a></li>
</ul>

<hr />

<p><a name="Exercises"></a></p>

<h2 id="Exercises">练习</h2>

<p>此动手实验包括以下练习：</p>

<ul>
<li><p><a href="#Exercise1">创建 SQL Server 虚拟机</a></p></li>
<li><p><a href="#Exercise2">部署简单的 MVC4 应用程序</a></p></li>
</ul>

<p>完成此实验的估计时间：<strong>45 分钟</strong>。</p>

<p><a name="Exercise1"></a></p>

<h3 id="Exercise_1_Creating_a_SQL_Server_Virtual_Machine">练习 1：创建 SQL Server 虚拟机</h3>

<p>在此练习中，您将新建一个包含 SQL Server 的新虚拟机，并配置一个公共端点以便对它进行远程访问。</p>

<p><a name="Ex1Task1"></a></p>

<h4 id="Task_1_-_Creating_a_Virtual_Machine_Using_the_Windows_Azure_Portal">任务 1 - 使用 Windows Azure 门户创建虚拟机</h4>

<p>在此任务中，您将使用 Windows Azure 门户创建一个新的虚拟机。</p>

<ol>
<li><p>转到 <a href="https://manage.windowsazure.com">Windows Azure 管理门户</a>并使用您的 Windows 帐户凭据登录。</p>

<p><img src="Images/login.png?raw=true" alt="登录到 Windows Azure 门户" title="登录到 Windows Azure 门户" />
</p>

<p><em>登录到 Windows Azure 管理门户</em></p></li>
<li><p>单击<strong>“新建”</strong>，选择<strong>“计算”</strong>|<strong>“虚拟机”</strong>选项，然后选择<strong>“从库中”</strong>。</p>

<p><img src="Images/creating-a-new-vm.png?raw=true" alt="新建虚拟机" title="新建虚拟机" />
</p>

<p><em>新建虚拟机</em></p></li>
<li><p>在<strong>“选择虚拟机操作系统”</strong>页中，单击左侧菜单中的<strong>“平台映像”</strong>，然后从列表中选择 <strong>Microsoft SQL Server 2012 SP1 Evaluation Edition</strong> 操作系统映像。单击“下一步”箭头以继续。</p></li>
<li><p>在<strong>“虚拟机配置”</strong>页中，输入<strong>“虚拟机名称”</strong>，为<strong>“新用户名”</strong>字段提供一个用户名，为<strong>“新密码”</strong>和<strong>“确认密码”</strong>字段提供一个密码。最后，将虚拟机的<strong>“大小”</strong>设置为<em>“小”</em>，然后单击<strong>“下一步”</strong>继续。</p>
<blockquote>
<p><strong>注意：</strong>在后面的步骤中将使用这些凭据通过远程桌面连接虚拟机。</p>
</blockquote>
<p><img src="Images/vm-configuration.png?raw=true" alt="虚拟机配置" title="虚拟机配置" />
</p>

<p><em>虚拟机配置</em></p></li>
<li><p>在<strong>“虚拟机模式”</strong>页中，选择<strong>“独立虚拟机”</strong>选项并提供一个唯一名称作为<strong>“DNS 名称”</strong>。然后选择一个<strong>存储帐户</strong>或保留默认值<em>“使用自动生成的存储帐户”</em>，选择一个<strong>区域/地缘组/虚拟网络</strong>并单击<strong>“下一步”</strong>。</p>

<p><img src="./Images/Selecting-VM-mode.png?raw=true" alt="选择虚拟机模式" title="选择虚拟机模式" />
</p>

<p><em>选择虚拟机模式</em></p></li>
<li><p>在<strong>“虚拟机选项”</strong>页中，保留默认选项并单击<strong>“完成”</strong>按钮创建虚拟机。</p>
<blockquote>
<p><strong>注意：</strong>虚拟机完成设置过程需要 8 到 10 分钟。</p>
</blockquote></li>
<li><p>在<strong>“虚拟机”</strong>部分中，您将看到刚创建的虚拟机，并且显示<em>“正在配置”</em>状态。等待状态变为<em>“正在运行”</em>，然后再继续后面的步骤。</p></li>
<li><p>在<strong>“虚拟机”</strong>部分中，找到刚刚创建的虚拟机并单击该虚拟机的名称。进入<strong>“仪表板”</strong>页以后，单击<strong>“端点”</strong>。</p></li>
<li><p>单击<strong>“添加端点”</strong>，选择“添加端点”选项，然后单击<strong>“下一步”</strong>按钮继续。</p>

<p><img src="Images/adding-a-new-endpoint.png?raw=true" alt="添加新端点" title="添加新端点" />
</p>

<p><em>添加新端点</em></p></li>
<li><p>在<strong>“新端点详细信息”</strong>页上，将<strong>“名称”</strong>设置为 <em>sqlserver</em>，<strong>“协议”</strong>设置为 <em>TCP</em>，<strong>“公用端口”</strong>设置为 57500，<strong>“专用端口”</strong>设置为 1433。</p>

<p><img src="Images/new-endpoint-details.png?raw=true" alt="新端点详细信息" title="新端点详细信息" />
</p>

<p><em>新端点详细信息</em></p></li>
<li><p>现在，您将创建并附加空数据磁盘来存储 SQL Server 日志和数据文件，还要添加一个端点。为此，请在<strong>“虚拟机”</strong>部分，选择在此任务中所创建的 SQL Server 虚拟机。</p></li>
<li><p>在虚拟机的<strong>“仪表板”</strong>中，单击页面底部菜单中的<strong>“附加”</strong>并选择<strong>“附加空磁盘”</strong>。</p>

<p><img src="Images/attach-empty-disk.png?raw=true" alt="附加空磁盘" title="附加空磁盘" />
</p>

<p><em>附加空磁盘</em></p></li>
<li><p>在<strong>“附加空磁盘”</strong>页中，将<strong>“大小”</strong>设置为 <em>50</em> GB，然后创建磁盘。</p></li>
<li><p>等待附加磁盘过程完成。重复步骤 11 至 13 创建第二个磁盘。</p></li>
<li><p>您将看到三个虚拟机磁盘：<strong>操作系统</strong>磁盘和用于<strong>数据</strong>和<strong>日志</strong>的另外两个磁盘。</p>
<blockquote>
<p><strong>注意：</strong>数据磁盘可能需要几分钟才能在 Azure 门户内的虚拟机仪表板中出现。</p>
</blockquote></li>
</ol>

<p><a name="Ex1Task2"></a></p>

<h4 id="Task_2_-_Configuring_SQL_Server_2012_Instance">任务 2 - 配置 SQL Server 2012 实例</h4>

<p>在此任务中，您将安装 SQL Server 并将其配置为启用远程访问。</p>

<ol>
<li><p>在 Windows Azure 管理门户菜单中，单击左侧菜单上的<strong>“虚拟机”</strong>。</p>

<p><img src="./Images/Windows-Azure-Portal.png?raw=true" alt="Windows Azure 门户" title="Windows Azure 门户" />
</p>

<p><em>Windows Azure 门户菜单</em></p></li>
<li><p>从“虚拟机”列表中选择您的虚拟机，然后单击<strong>“连接”</strong>以使用<strong>远程桌面连接</strong>进行连接。一个 RDP 文件将下载到您的本地计算机中，需要打开该文件以便启动<em>远程桌面</em>。</p></li>
<li><p>在虚拟机中，从<strong>“开始”|“所有程序”|“管理工具”</strong>中打开<strong>“服务器管理器”</strong>。</p></li>
<li><p>展开<strong>“存储”</strong>节点，然后选择<strong>“磁盘管理”</strong>选项。</p>

<p><img src="Images/disk-management2.png?raw=true" alt="磁盘管理 (2)" />
</p>

<p><em>磁盘管理</em></p></li>
<li><p>选择“磁盘管理”后，会显示一个<strong>“初始化磁盘”</strong>对话框。保留默认值，然后单击<strong>“确定”</strong>。</p>
<blockquote>
<p><strong>注意</strong>：如果选择“磁盘管理”后未显示“初始化磁盘”对话框，请从 Windows Azure 管理门户找到您使用<strong>“附加空磁盘”</strong>功能创建的磁盘，右键单击第一个磁盘并选择<strong>“初始化磁盘”</strong>。保留默认值，然后单击<strong>“确定”</strong>。</p>
</blockquote></li>
<li><p>右键单击第一个磁盘的未分配空间并选择<strong>“新建简单卷”</strong>。</p>

<p><img src="Images/disk-management.png?raw=true" alt="磁盘管理" />
</p>

<p><em>磁盘管理</em></p></li>
<li><p>按照<strong>“新建简单卷向导”</strong>执行，保留所有默认值。在系统要求输入<strong>卷标</strong>时，将其设置为 <em>SQLData</em>。</p></li>
<li><p>等待第一个磁盘创建完成。重复步骤 5 至 8，但这次使用第二个磁盘。将<strong>“卷标”</strong>设置为 <em>SQLLogs</em>。</p></li>
<li><p>现在，可用磁盘的<strong>“磁盘管理”</strong>列表应显示 <strong>SQLData</strong> 和 <strong>SQLLogs</strong> 磁盘，如下图所示：</p>

<p><img src="./Images/Disks-Management.png?raw=true" alt="磁盘管理" title="磁盘管理" />
</p>

<p><em>磁盘管理</em></p></li>
<li><p>从<strong>“开始”|“所有程序”|“Microsoft SQL Server 2012”|“配置工具”</strong>中打开<strong>“SQL Server 配置管理器”</strong>。</p></li>
<li><p>展开<strong>“SQL Server 网络配置”</strong>节点并选择<strong>“MSSQLServer 的协议”</strong>（如果在安装 SQL Server 时使用了不同的实例名称，此选项可能有所不同）。确保启用了 <strong>Shared Memory</strong>、<strong>Named Pipes</strong> 和 <strong>TCP/IP</strong> 协议。要启用某一协议，请右键单击协议名称并选择<strong>“启用”</strong>。</p>

<p><img src="./Images/Enabling-SQL-Server-Protocols.png?raw=true" alt="启用 SQL Server 协议" title="启用 SQL Server 协议" />
</p>

<p><em>启用 SQL Server 协议</em></p></li>
<li><p>转到<strong>“SQL Server 服务”</strong>节点，右键单击 <strong>SQL Server (MSSQLSERVER)</strong> 项并选择<strong>“重新启动”</strong>。</p></li>
</ol>

<p><a name="Ex1Task3"></a></p>

<h4 id="Task_3_-_Installing_the_AdventureWorks_Database">任务 3 - 安装 AdventureWorks 数据库</h4>

<p>在此任务中，您将添加 <strong>AdventureWorks</strong> 数据库，后面练习中的示例应用程序将用到这个数据库。</p>

<ol>
<li><p>为启用从 IE 下载，需要更新<strong>“Internet Explorer 增强的安全配置”</strong>。在 Azure 虚拟机中，从<strong>“开始”|“所有程序”|“管理工具”</strong>中打开<strong>“服务器管理器”</strong>。</p></li>
<li><p>在<strong>“服务器管理器”</strong>窗口中，单击<strong>“安全信息”</strong>部分的<strong>“配置 IE ESC”</strong>。</p>

<p><img src="Images/configure-internet-explorer-enhanced-security.png?raw=true" alt="设置 Internet Explorer 增强的安全配置" title="设置 Internet Explorer 增强的安全配置" />
</p>

<p><em>设置 Internet Explorer 增强的安全配置</em></p></li>
<li><p>在<strong>“Internet Explorer 增强的安全配置”</strong>对话框中，<strong>关闭</strong><strong>管理员</strong>的增强安全配置，然后单击<strong>“确定”</strong>。</p>

<p><img src="./Images/Internet-Explorer-Enhanced-Security.png?raw=true" alt="Internet Explorer 增强的安全配置" title="Internet Explorer 增强的安全配置" />
</p>

<p><em>Internet Explorer 增强的安全配置</em></p>
<blockquote>
<p><strong>注意：</strong>修改“Internet Explorer 增强的安全配置”不宜作为常规做法，在此仅为本次特定实验临时使用。正确的做法应是从本地下载文件，然后将文件复制到共享文件夹或直接复制到虚拟机。</p>
</blockquote></li>
<li><p>从<strong>“开始”|“所有程序”|“Microsoft SQL Server 2012”|“SQL Server Management Studio”</strong>打开 SQL Server Management Studio。</p></li>
<li><p>使用您的 Windows 帐户连接到 SQL Server 2012 默认实例。</p></li>
<li><p>现在，您将更新数据库的默认位置以便拆分“日志”和“数据”。为此，请右键单击您的 SQL Server 实例，再选择<strong>“属性”</strong>。</p></li>
<li><p>从左侧窗格中选择<strong>“数据库设置”</strong>。</p></li>
<li><p>找到<strong>“数据库默认位置”</strong>部分，更新默认值使之指向在前面的任务中附加的磁盘。</p>

<p><img src="./Images/Setting-Database-Default-Locations.png?raw=true" alt="设置数据库默认位置" title="设置数据库默认位置" />
</p>

<p><em>设置数据库默认位置</em></p></li>
<li><p>使用 Windows 资源管理器创建以下文件夹：<strong>F:\Data、G:\Logs</strong> 和 <strong>G:\Backups</strong>。</p></li>
<li><p>重新启动 SQL Server。为此，返回到 <strong>SQL Server Management Studio</strong>，在<strong>对象资源管理器</strong>中，右键单击服务器节点，然后选择<strong>“重新启动”</strong>。确认提示的对话框。</p></li>
<li><p>此实验使用 <strong>AdventureWorks2012</strong> 数据库。打开 <strong>Internet Explorer</strong> 浏览器，然后浏览到 <a href="http://msftdbprodsamples.codeplex.com/">http://msftdbprodsamples.codeplex.com/</a> 下载 <strong>SQL Server 2012</strong> 示例数据库。</p></li>
<li><p>右键单击下载的文件，然后选择<strong>“属性”</strong>。单击<strong>“取消阻止”</strong>，然后通过单击<strong>“确定”</strong>关闭对话框。</p></li>
<li><p>解压缩数据库文件。</p></li>
<li><p>将 <strong>AdventureWorks2012</strong> 示例数据库添加到您的 SQL Server 中。为此，请打开 <strong>SQL Server Management Studio</strong>，并使用您的 Windows 帐户连接到 <strong>(local)</strong>。找到您的 SQL Server 实例节点并将其展开。</p></li>
<li><p>右键单击<strong>“数据库”</strong>文件夹并选择<strong>“附加”</strong>。</p>

<p><img src="Images/attaching-adventureworks-database-menu.png?raw=true" alt="对象资源管理器 - 附加 AdventureWorks 数据库" />
</p>

<p><em>对象资源管理器 - 附加 Adventureworks2012 数据库</em></p></li>
<li><p>在<strong>“附加数据库”</strong>对话框中，按<strong>“添加”</strong>。浏览到示例数据库的安装路径并选择 <strong>AdventureWorks2012</strong> 数据文件。单击<strong>“确定”</strong>。</p></li>
<li><p>现在，在<strong>“数据库详细信息”</strong>中选择 AdventureWorks2012 日志行，然后单击<strong>“删除”</strong>。</p>

<p><img src="./Images/attaching-adventureworks-database.png?raw=true" alt="附加 AdventureWorks 数据库" title="附加 AdventureWorks 数据库" />
</p>

<p><em>附加 AdventureWorks2012 数据库</em></p></li>
<li><p>单击<strong>“确定”</strong>附加数据库。</p></li>
<li><p>为数据库创建全文目录。您将在下一练习中部署的 MVC 应用程序中使用此功能。为此，展开 <em>Databases\AdventureWorks2012\Storage</em> 节点，右键单击<strong>“全文目录”</strong>文件夹并选择<strong>“新建全文目录”</strong>。</p>

<p><img src="Images/new-full-text-catalog.png?raw=true" alt="新建全文目录" title="新建全文目录" />
</p>

<p><em>新建全文目录</em></p></li>
<li><p>在<strong>“新建全文目录”</strong>对话框中，将<strong>“名称”</strong>值设置为 <em>AdventureWorksCatalog</em>，然后按<strong>“确定”</strong>。</p>

<p><img src="Images/new-full-text-catalog-name.png?raw=true" alt="新全文目录名称" title="新全文目录名称" />
</p>

<p><em>全文目录创建</em></p></li>
<li><p>右键单击 <strong>AdventureWorksCatalog</strong>，然后选择<strong>“属性”</strong>。选择<strong>“表/视图”</strong>菜单项。将 <strong>Production.Product</strong> 表添加到<strong>“分配给该目录的表/视图对象”</strong>列表中。最后，从<strong>“合格列”</strong>中选择<em>“名称”</em>，在<em>“断字符语言”</em>列中选择<strong>“英语”</strong>，然后单击<strong>“确定”</strong>。</p>

<p><img src="Images/full-text-catalog-properties.png?raw=true" alt="全文目录属性" title="全文目录属性" />
</p>

<p><em>全文目录属性</em></p></li>
<li><p>在 SQL Server 实例中启用<strong>混合模式身份验证</strong>。为此，请在 <strong>SQL Server Management Studio</strong> 中右键单击服务器实例，然后单击<strong>“属性”</strong>。</p></li>
<li><p>在右侧窗格中选择<strong>“安全性”</strong>页面，然后在<strong>“服务器身份验证”</strong>部分下选择<strong>“SQL Server 和 Windows 身份验证模式”</strong>。单击<strong>“确定”</strong>保存更改。</p>

<p><img src="Images/mixed-authentication-mode.png?raw=true" alt="混合身份验证模式" title="混合身份验证模式" />
</p>

<p><em>混合身份验证模式</em></p></li>
<li><p>重新启动 SQL Server 实例。为此，请右键单击 SQL Server 实例，然后单击<strong>“重新启动”</strong>。</p></li>
<li><p>添加一个新用户，该用户将用于下面练习中部署的 MVC4 应用程序。为此，请展开 SQL Server 实例中的<strong>“安全性”</strong>文件夹。右键单击<strong>“登录”</strong>文件夹，然后选择<strong>“新建登录名”</strong>。</p>

<p><img src="./Images/create-new-login.png?raw=true" alt="创建新登录名" title="创建新登录名" />
</p>

<p><em>创建新登录名</em></p></li>
<li><p>在<strong>“常规”</strong>部分，将<strong>“登录名”</strong>设置为 <em>CloudShop</em>。选择<strong>“SQL Server 身份验证”</strong>选项并将<strong>“密码”</strong>设置为 <em>Azure$123</em>。</p>
<blockquote>
<p><strong>注意：</strong>如果您输入的用户名或密码与本步骤中的建议不同，则需要更新下一练习中将使用的 MVC4 应用程序的 web.config 文件，以使这些值匹配。</p>
</blockquote></li>
<li><p>取消选中<strong>“强制实施密码策略”</strong>选项以避免首次登录时必须更改用户密码，并将<strong>“默认数据库”</strong>设置为 <em>AdventureWorks2012</em>。</p>

<p><img src="Images/new-logins-general-settings.png?raw=true" alt="新登录名的常规设置" title="新登录名的常规设置" />
</p>

<p><em>创建新登录名</em></p></li>
<li><p>转到<strong>“用户映射”</strong>部分。将用户映射到 <em>AdventureWorks2012</em> 数据库，并单击<strong>“确定”</strong>。</p>

<p><img src="./Images/Mapping-the-new-User.png?raw=true" alt="将新用户映射到 AdventureWorks 数据库" title="将新用户映射到 AdventureWorks 数据库" />
</p>

<p><em>将新用户映射到 AdventureWorks 数据库</em></p></li>
<li><p>展开<strong>“数据库”</strong>文件夹中的 <strong>AdventureWorks2012</strong> 数据库。在<strong>“安全性”</strong>文件夹中，展开<strong>“用户”</strong>并双击 <strong>CloudShop</strong> 用户。</p></li>
<li><p>转到<strong>“成员身份”</strong>页，再选择 <strong>CloudShop</strong> 用户的 <em>db_owner</em> 角色复选框，然后单击<strong>“确定”</strong>。</p>

<p><img src="./Images/Adding-Database-role-membership-to-CloudShop-user.png?raw=true" alt="向 CloudShop 用户添加数据库角色成员身份" title="向 CloudShop 用户添加数据库角色成员身份" />
</p>

<p><em>向 CloudShop 用户添加数据库角色成员身份</em></p>
<blockquote>
<p><strong>注意：</strong>在下一练习中部署的应用程序将使用“通用提供程序”管理会话。应用程序首次运行时，提供程序将在 AdventureWorks 数据库中创建一个 Sessions 表。因此，您将把 db_owner 角色分配给 CloudShop 用户。首次运行该应用程序后，就可以移除该用户的此角色，因为该用户不再需要这些权限。</p>
</blockquote></li>
<li><p>关闭 <strong>SQL Server Management Studio</strong>。</p></li>
<li><p>为允许 MVC4 应用程序访问 SQL Server 数据库，您需要在<strong>“Windows 防火墙”</strong>中为 SQL Server 请求添加一条<strong>“入站规则”</strong>。为此，请从<strong>“开始”|“所有程序”|“管理工具”</strong>中打开<strong>“高级安全 Windows 防火墙”</strong>。</p></li>
<li><p>选择<strong>“入站规则”</strong>节点，右键单击它并选择<strong>“新建规则”</strong>。</p>

<p><img src="./Images/Creating-an-Inbound-Rule.png?raw=true" alt="创建入站规则" title="创建入站规则" />
</p>

<p><em>创建入站规则</em></p></li>
<li><p>在<strong>“新建入站规则向导”</strong>中选择<em>“端口”</em>作为<strong>“规则类型”</strong>，然后单击<strong>“下一步”</strong>。</p>

<p><img src="Images/new-inbound-rule-type.png?raw=true" alt="新入站规则类型" title="入站规则类型" />
</p>

<p><em>入站规则的类型</em></p></li>
<li><p>在<strong>“协议和端口”</strong>步骤中，选择<strong>“特定本地端口”</strong>并将其值设置为 <em>1433</em>。单击<strong>“下一步”</strong>继续。</p>

<p><img src="Images/inbound-rules-local-port.png?raw=true" alt="入站规则的本地端口" title="入站规则的本地端口" />
</p>

<p><em>入站规则的本地端口</em></p></li>
<li><p>在<strong>“操作”</strong>步骤中，确保选中<strong>“允许连接”</strong>并单击<strong>“下一步”</strong>。</p>

<p><img src="Images/inbound-rules-action.png?raw=true" alt="入站规则的操作" title="入站规则的操作" />
</p>

<p><em>入站规则的操作</em></p></li>
<li><p>在<strong>“配置文件”</strong>步骤中，保留默认值，然后单击<strong>“下一步”</strong>。</p></li>
<li><p>最后，将入站规则的<strong>名称</strong>设置为 <em>SQLServerRule</em> 并单击<strong>“完成”</strong>。</p>

<p><img src="Images/new-inbound-rule.png?raw=true" alt="新入站规则" title="新入站规则" />
</p>

<p><em>新入站规则</em></p></li>
<li><p>关闭<strong>“高级安全 Windows 防火墙”</strong>窗口，然后关闭<strong>远程桌面连接</strong>。</p></li>
</ol>

<p><a name="Exercise2"></a></p>

<h3 id="Exercise_2_Deploying_a_Simple_MVC4_Application">练习 2：部署简单的 MVC4 应用程序</h3>

<p>在本练习中，您将配置一个简单的 Web 应用程序，它将使用公用端点连接到在上一练习中创建的 SQL Server 实例。使用本地 Azure 仿真程序测试该应用程序。然后，将该应用程序发布到 <strong>Windows Azure</strong> 并在云中运行。</p>

<p><a name="Ex2Task1"></a></p>

<h4 id="Task_1_-_Configuring_the_MVC4_Application_to_Connect_to_a_SQL_Server_Instance">任务 1 - 配置 MVC4 应用程序以连接到 SQL Server 实例</h4>

<p>在此任务中，您将更改连接字符串，使其指向在上一练习中创建的 SQL Server 实例。</p>

<ol>
<li><p>以管理员身份打开 Visual Studio 2012 Express for Web 或更高版本。</p></li>
<li><p>打开位于本实验 <strong>Source</strong> 文件夹下的 <strong>Ex02-DeploySampleApp</strong> 文件夹中的 <strong>IaaSDeploySimpleApp.sln</strong> 解决方案。</p></li>
<li><p>打开位于 <strong>CloudShop</strong> 项目的 <strong>Web.config</strong> 文件，然后找到 <strong>connectionStrings</strong> 节点。将 <strong>Data Source</strong> 属性值替换为 SQL Server 虚拟机的公用 DNS 的地址、在上一练习中创建的 SQL Server 实例名和公用端口端点（例如：<em>vmname.cloudapp.net,57500</em>）。</p>

<!--mark: 1-5 -->

<span class="codelanguage">XML</span><pre><code class="XML"><strong class="markLine"><span style="color:#0000FF">&lt;</span><span style="color:#800000">connectionStrings</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">    <span style="color:#0000FF">&lt;</span><span style="color:#800000">add</span> <span style="color:#FF0000">name</span>=<span style="color:#0000FF">&quot;DefaultConnection&quot;</span> <span style="color:#FF0000">connectionString</span>=<span style="color:#0000FF">&quot;Data Source=[YOUR-VM-DNS-NAME].cloudapp.net, 57500;initial catalog=AdventureWorksLT2008R2;Uid=CloudShop;Password=Azure$123;MultipleActiveResultSets=True&quot;</span> <span style="color:#FF0000">providerName</span>=<span style="color:#0000FF">&quot;System.Data.SqlClient&quot;</span> <span style="color:#0000FF">/&gt;</span></strong>
<strong class="markLine">    <span style="color:#0000FF">&lt;</span><span style="color:#800000">add</span> <span style="color:#FF0000">name</span>=<span style="color:#0000FF">&quot;AdventureWorksEntities&quot;</span> <span style="color:#FF0000">connectionString</span>=<span style="color:#0000FF">&quot;metadata=res://*/Models.AdventureWorks.csdl|res://*/Models.AdventureWorks.ssdl|res://*/Models.AdventureWorks.msl;provider=System.Data.SqlClient;provider connection string=&amp;quot;data source= [YOUR-VM-DNS-NAME].cloudapp.net, 57500;initial catalog=AdventureWorksLT2008R2;Uid=CloudShop;Password=Azure$123;multipleactiveresultsets=True;App=EntityFramework&amp;quot;&quot;</span> <span style="color:#FF0000">providerName</span>=<span style="color:#0000FF">&quot;System.Data.EntityClient&quot;</span> <span style="color:#0000FF">/&gt;</span></strong>
<strong class="markLine"><span style="color:#0000FF">&lt;/</span><span style="color:#800000">connectionStrings</span><span style="color:#0000FF">&gt;</span></strong>
</code></pre></li>
<li><p>编译并运行该解决方案。</p>
<blockquote>
<p><strong>注意</strong>：运行应用程序前请确保将 CloudShop.Azure 项目设置为启动项目。</p>
</blockquote></li>
<li><p>在主页上，产品列表将用 SQL Server 实例中的数据填充。输入任意文本并单击 <strong>Search</strong>（搜索）链接执行搜索。这将筛选产品列表。</p>

<p><img src="./Images/Verifying-that-the-sample-application-is-connected-to-the-SQL-Server-instance.png?raw=true" alt="验证示例应用程序连接到 SQL Server 实例" title="验证示例应用程序连接到 SQL Server 实例" />
</p>

<p><em>验证示例应用程序连接到 SQL Server 实例</em></p></li>
<li><p>关闭浏览器，返回 <strong>Visual Studio</strong>。</p></li>
</ol>

<p><a name="Ex2Task2"></a></p>

<h4 id="Task_2_-_Publishing_the_MVC4_Application_to_Windows_Azure">任务 2 - 将 MVC4 应用程序发布到 Windows Azure</h4>

<p>在此任务中，您将下载您帐户的发布设置并从 Visual Studio 发布 Web 应用程序。</p>

<ol>
<li><p>打开 Internet Explorer，转到 <a href="https://windows.azure.com/download/publishprofile.aspx">https://windows.azure.com/download/publishprofile.aspx</a>。</p></li>
<li><p>将发布设置文件<strong>保存</strong>到本地计算机。</p>

<p><img src="Images/downloading-publish-settings-file.png?raw=true" alt="下载发布设置文件" title="下载发布设置文件" />
</p>

<p><em>下载发布设置文件</em></p></li>
<li><p>切换到 Visual Studio。右键单击 <strong>CloudShop.Azure</strong> 项目并选择<strong>“发布”</strong>。</p>

<p><img src="./Images/Publishing-the-Cloud-Application.png?raw=true" alt="发布云应用程序" title="发布云应用程序" />
</p>

<p><em>发布云应用程序</em></p></li>
<li><p>在<strong>“发布 Windows Azure 应用程序”</strong>向导中，单击<strong>“导入”</strong>按钮并选择您刚下载的发布设置文件。确保在下拉列表中选中该项，然后单击<strong>“下一步”</strong>。</p>

<p><img src="./Images/Importing-the-Publishing-Settings.png?raw=true" alt="导入发布设置" title="导入发布设置" />
</p>

<p><em>导入发布设置</em></p></li>
<li><p>在<strong>“Windows Azure 发布设置”</strong>页中，展开<strong>“云服务”</strong>下拉列表并选择<strong>“新建”</strong>。在对话框中为云服务输入一个名称并选择一个位置。单击<strong>“确定”</strong>继续。</p>

<p><img src="./Images/Creating-a-New-Cloud-Service.png?raw=true" alt="创建新的云服务" title="创建新的云服务" />
</p>

<p><em>创建新的云服务</em></p></li>
<li><p>确保将<strong>“环境”</strong>设置为<em>“生产”</em>，<strong>“生成配置”</strong>设置为<em>“发布”</em>，<strong>“服务配置”</strong>设置为<em>“云”</em>。单击<strong>“下一步”</strong>。</p></li>
<li><p>在<strong>“Windows Azure 发布摘要”</strong>页中，单击<strong>“发布”</strong>。等待部署完成。单击<strong>“网站 URL”</strong>链接。</p>

<p><img src="./Images/Deployment-Activity-Log.png?raw=true" alt="部署活动日志" title="部署活动日志" />
</p>

<p><em>部署活动日志</em></p></li>
<li><p>浏览器将显示 <strong>Cloud Shop</strong> 示例应用程序的主页。在<strong>搜索</strong>框中，输入 <em>Classic</em>，然后单击 <strong>Search</strong>（搜索）。页面会显示具有与搜索条件相符的 <em>ProductName</em> 或 <em>QuantityPerUnit</em> 字段的所有产品。云应用正在使用公用端点访问 SQL Server 以检索产品列表。</p>

<p><img src="./Images/Searching-Products.png?raw=true" alt="搜索产品" title="搜索产品" />
</p>

<p><em>搜索产品</em></p></li>
</ol>

<hr />

<p><a name="Summary"></a></p>

<h2 id="Summary">小结</h2>

<p>通过完成此动手实验，您学习了如何：</p>

<ul>
<li>配置 SQL Server 虚拟机</li>
<li>使用公用端点连接示例 Web 应用程序和 SQL Server</li>
<li>将示例 Web 应用程序部署到 Windows Azure 中的云应用</li>
</ul> </span>
		</div>
	<br/>
	<p><a href="#top">返回页首</a></p>


				</div>
			</section>
			<footer>
				<div class="footer-sitemap" style="border-top:0"></div>
				<div class="footer-bottom">
					<ul>
						<li class="footer-copyright"><a href="http://www.microsoft.com"><img alt="microsoft" src="images/microsoft.png" /></a></li>					
												<li><a href="https://github.com/WindowsAzure-TrainingKit/HOL-ConnectingApplications/issues" target="_new">记录问题</a></li>
												<li><a href="mailto:azcfeed@microsoft.com?subject=Windows Azure Training Kit">联系我们</a></li>
						<li><a href="EULA.htm">使用条款</a></li>
						<li><a href=".\">浏览内容</a></li>
						<li>&copy; 2012 Microsoft</li>
					</ul>
				</div>
			</footer>
			</div>
        </div>
    </div>
</body>
</html>

